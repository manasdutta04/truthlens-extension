(()=>{"use strict";let e=null;function t(){chrome.tabs.create({url:chrome.runtime.getURL("settings.html")})}function r(e){try{console.log("TruthLens: Updating badge with score",e);let t="#10b981";e<.4?t="#ef4444":e<.7&&(t="#f59e0b"),chrome.action.setBadgeBackgroundColor({color:t});const r=Math.round(100*e);chrome.action.setBadgeText({text:`${r}%`})}catch(e){console.error("TruthLens: Error updating badge",e),chrome.action.setBadgeText({text:""})}}console.log("TruthLens: Background script started"),chrome.runtime.onMessage.addListener(((s,n,o)=>{console.log("TruthLens: Received message",s);try{if("saveAnalysisResult"===s.action)return console.log("TruthLens: Saving analysis result",s.data),e=s.data,s.data&&s.data.result&&void 0!==s.data.result.credibilityScore?r(s.data.result.credibilityScore):(console.warn("TruthLens: Missing credibility score in data",s.data),chrome.action.setBadgeText({text:""})),o({success:!0}),!0;if("getAnalysisResult"===s.action){if(console.log("TruthLens: Returning analysis result",e),e)return o({data:e}),!0;try{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{const t=e&&e.length>0?e[0]:null;if(!t||!t.url)return console.warn("TruthLens: No active tab found when requesting analysis result"),void o({data:null,error:"No active tab"});console.log(`TruthLens: No analysis data for tab: ${t.url}`),o({data:null})}))}catch(e){console.error("TruthLens: Error querying tabs",e),o({data:null,error:"Tab query error"})}return!0}if("openPopup"===s.action)return function(){try{chrome.action.setBadgeText({text:"!!!"}),chrome.action.setBadgeBackgroundColor({color:"#6366f1"}),setTimeout((()=>{e&&e.result?r(e.result.credibilityScore):chrome.action.setBadgeText({text:""})}),1e3)}catch(e){console.error("TruthLens: Error flashing icon",e)}}(),o({success:!0}),!0;if("clearAnalysisResult"===s.action)return console.log("TruthLens: Clearing analysis result"),e=null,chrome.action.setBadgeText({text:""}),o({success:!0}),!0;if("openSettings"===s.action)return t(),o({success:!0}),!0;console.warn("TruthLens: Unknown message action",s.action),o({success:!1,error:"Unknown action"})}catch(e){console.error("TruthLens: Error processing message",e),o({success:!1,error:String(e)})}return!1})),chrome.runtime.onInstalled.addListener((()=>{console.log("TruthLens extension installed or updated"),chrome.action.setBadgeText({text:""}),chrome.storage.local.get("settings",(e=>{if(e.settings){const t={autoAnalyze:!0,notifyLowTrust:!0,rememberHistory:!0,preferredTheme:"system",badgePosition:"top-right"},r=Object.assign(Object.assign({},t),e.settings);JSON.stringify(r)!==JSON.stringify(e.settings)&&(chrome.storage.local.set({settings:r}),console.log("TruthLens: Updated settings with new defaults"))}else chrome.storage.local.set({settings:{autoAnalyze:!0,notifyLowTrust:!0,rememberHistory:!0,preferredTheme:"system",badgePosition:"top-right"}}),console.log("TruthLens: Initialized default settings")})),chrome.contextMenus.create({id:"truthlens-settings",title:"TruthLens Settings",contexts:["action"]})})),chrome.contextMenus.onClicked.addListener(((e,r)=>{"truthlens-settings"===e.menuItemId&&t()})),chrome.tabs.onUpdated.addListener(((t,r,s)=>{"complete"===r.status&&s.url&&e&&e.url&&s.url!==e.url&&chrome.action.setBadgeText({text:""})}))})();